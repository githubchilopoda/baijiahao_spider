#encoding=utf8
from django.shortcuts import render
from django.http import JsonResponse, HttpResponseRedirect
from django.conf import settings
import json
from backend.models import *
import requests
from bs4 import BeautifulSoup
# Create your views here.
from portal.models import Data
import sys
reload(sys)
sys.setdefaultencoding('utf8')

def need_login(func):
    def _need_login(request):
        if not request.session.get("backuser", False):
            return JsonResponse({
                'error_no': '-1',
                'message': 'need login'
            })
        else:
            return func(request)

    return _need_login


def login(request):
    if request.POST.get('uname') == 'admin' and request.POST.get('passwd') == 'pppxx77!@#':
        request.session['backuser'] == 'baidu_user'
        return JsonResponse({
            "error_no": "0",
            "data": {
                "message": "login success"
            }
        })
    else:
        return JsonResponse({
            "error_no": "1",
            "data": {
                "message": "login fail"
            }
        })


@need_login
def get_types(request):
    t = Type.objects.filter(status=1)
    return JsonResponse({
        'error_no' : '0',
        'data' : [i.message() for i in t]
    })


@need_login
def new_type(request):
    name = request.POST.get('name')
    t = Type(name=name)
    t.save()
    return JsonResponse({
        'error_no' : '0'
    })

@need_login
def delete_type(request):
    t = Type.objects.filter(id=request.GET.get('id'))
    if len(t) == 0:
        return JsonResponse({
            'error_no' : '1',
            'data' : {
                'message' : 'no such id'
            }
        })
    else :
        t[0].status = 0
        t[0].save()
        return JsonResponse({
            'error_no' : '0',
        })


@need_login
def get_data(request):
    d = Data.objects.filter(type=request.GET.get('type'))
    return JsonResponse({
        'error_no' : '0',
        'data' : [i.message() for i in d]
    })


def spider_youku(request):
    url = request.GET.get('url')
    j_url = url.split('?')[0] + '/video'+ '?' + url.split('?')[1]
    j = requests.get(j_url)
    soup = BeautifulSoup(j.text)
    for i in soup.find_all("div",class_='v-meta-title'):
        title = i.find("a").attrs.get('title') if i.find("a").attrs.get('title') is not None else i.find("a").string
        if len(Data.objects.filter(title=title)) :
            pass
        else :
            d = Data(title=title,origin_id='',origin=u'优酷',origin_user_id=url)
            d.save()
    return JsonResponse({
        "error_no" : "0"
    })
def spider_kuaibao(request):
    url = request.GET.get('url')
    p = url.split('?')[1].split('=')
    key = p[1]
    json_url = 'https://kuaibao.qq.com/getMediaCardInfo?chlid=' + key
    j = requests.get(json_url)
    j_json = json.loads(j.text)

    for i in j_json['info']['newsList']:
        if len(Data.objects.filter(title=i['title'])) :
            pass
        else :
            d = Data(title=i['title'],origin_id=i['id'],origin=u'快报',origin_user_id=key)
            d.save()
    return JsonResponse({
        "error_no" : "0",
        "data" : j_json
    })


def spider_toutiao(request):
    url = request.GET.get('url')
    p = url.split('?')[0].split('/')
    key = p[-2]
    json_url = 'http://www.toutiao.com/c/user/article/?page_type=1&user_id='+key+'&max_behot_time=0&count=20&as=A1359929377D835&cp=59972D3853655E1'
    j = requests.get(json_url)
    j_json = json.loads(j.text)

    for i in j_json['data']:
        if len(Data.objects.filter(title=i['title'])) :
            pass
        else :
            d = Data(title=i['title'],origin_id=i['item_id'],origin=u'头条号',origin_user_id=key)
            d.save()
    return JsonResponse({
        "error_no" : "0",
        "data" : j_json
    })


def spider_bilibili(request):
    url = request.GET.get('url')
    p = url.split('?')[0].split('/')
    key = p[-1]
    json_url = 'http://space.bilibili.com/ajax/member/getSubmitVideos?mid='+key+'&pagesize=4&tid=0&page=1&keyword=&order=pubdate'
    j = requests.get(json_url)
    j_json = json.loads(j.text)

    for i in j_json['data']['vlist']:
        if len(Data.objects.filter(title=i['title'])) :
            pass
        else :
            d = Data(title=i['title'],origin_id=i['mid'],origin=u'bilibili',origin_user_id=key)
            d.save()
    return JsonResponse({
        "error_no" : "0",
        "data" : j_json
    })

def spider_baijiahao(request):
    url = request.GET.get('url')
    p = url.split('?')[1].split('=')
    key = ''
    for i in xrange(len(p)):
        if p[i] == 'app_id':
            key = p[i+1]
            break
    json_url = 'http://baijiahao.baidu.com/api/content/article/listall?sk=super&ak=super&app_id='+key+'&_skip=0&_limit=10&status=in:publish,published&_preload_statistic=1&_timg_cover=50,172,1000&_cache=1'
    j = requests.get(json_url)
    j_json = json.loads(j.text)

    for i in j_json['items']:
        if len(Data.objects.filter(title=i['title'])) :
            pass
        else :
            d = Data(title=i['title'],origin_id=i['id'],origin=u'百家号',origin_user_id=key)
            d.save()
    return JsonResponse({
        "error_no" : "0",
        "data" : j_json
    })